generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

model Post {
  id                String           @id @default(cuid())
  slug              String           @unique
  title             String
  content           String
  excerpt           String?
  published         Boolean          @default(false)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  seriesId          String?
  thumbnail         String?
  subSlug           String?          @unique
  type              PostType         @default(LONG)
  linkedinUrl       String?
  threadsUrl        String?
  linkedinContent   String?
  threadsContent    String[]         @default([])
  linkedShortPostId String?          @unique
  bookId            String?
  Comment           Comment[]
  book              Book?            @relation(fields: [bookId], references: [id])
  linkedShortPost   Post?            @relation("LongToShort", fields: [linkedShortPostId], references: [id])
  linkedLongPost    Post?            @relation("LongToShort")
  series            Series?          @relation(fields: [seriesId], references: [id])
  views             PostView[]
  readingSessions   ReadingSession[]
  tags              Tag[]            @relation("PostToTag")

  @@index([seriesId])
  @@index([bookId])
  @@index([type])
}

model Series {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  posts       Post[]
}

model Book {
  id         String    @id @default(cuid())
  title      String
  author     String
  slug       String    @unique
  coverImage String?
  startedAt  DateTime?
  finishedAt DateTime?
  summary    String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  posts      Post[]
}

model PostView {
  id        String   @id @default(cuid())
  postId    String
  viewedAt  DateTime @default(now())
  ipAddress String?
  userAgent String?
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([viewedAt])
}

model ReadingSession {
  id             String   @id @default(cuid())
  postId         String
  sessionId      String
  maxScrollDepth Float    @default(0)
  readingTime    Int      @default(0)
  completed      Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  post           Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, sessionId])
  @@index([postId])
  @@index([createdAt])
}

model Page {
  id        String   @id @default(cuid())
  slug      String   @unique
  title     String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Draft {
  id        String   @id @default(cuid())
  title     String   @default("")
  content   String   @default("")
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tags      Tag[]    @relation("DraftToTag")

  @@index([authorId])
}

model CustomSnippet {
  id        String   @id @default(cuid())
  name      String
  content   String
  shortcut  String?
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Tag {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  drafts    Draft[]  @relation("DraftToTag")
  posts     Post[]   @relation("PostToTag")

  @@index([name])
  @@index([slug])
}

model AIKnowledgePreset {
  id          String                 @id @default(cuid())
  name        String
  instruction String
  lastUsedAt  DateTime?
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  references  AIKnowledgeReference[]
}

model AIKnowledgeReference {
  id        String            @id @default(cuid())
  title     String
  content   String
  presetId  String
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  preset    AIKnowledgePreset @relation(fields: [presetId], references: [id], onDelete: Cascade)

  @@index([presetId])
}

model Comment {
  id              String            @id
  content         String
  postId          String
  authorId        String
  authorName      String?
  authorImage     String?
  parentId        String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  Comment         Comment?          @relation("CommentToComment", fields: [parentId], references: [id], onDelete: Cascade)
  other_Comment   Comment[]         @relation("CommentToComment")
  Post            Post              @relation(fields: [postId], references: [id], onDelete: Cascade)
  CommentReaction CommentReaction[]

  @@index([authorId])
  @@index([createdAt])
  @@index([parentId])
  @@index([postId])
}

model CommentReaction {
  id        String       @id
  commentId String
  userId    String
  type      ReactionType
  createdAt DateTime     @default(now())
  Comment   Comment      @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId, type])
  @@index([commentId])
  @@index([userId])
}

enum PostType {
  LONG
  SHORT
}

enum ReactionType {
  LIKE
  LOVE
  CELEBRATE
  INSIGHTFUL
}
