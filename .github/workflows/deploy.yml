name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_UNPOOLED }}
          DATABASE_URL_UNPOOLED: ${{ secrets.DATABASE_URL_UNPOOLED }}

      - name: Check migration status
        id: migration_check
        run: |
          STATUS=$(npx prisma migrate status --schema=prisma/schema.prisma 2>&1 || true)
          echo "$STATUS"

          if echo "$STATUS" | grep -q "Database schema is up to date"; then
            echo "migrations_needed=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No migrations needed"
          elif echo "$STATUS" | grep -q "following migrations have not yet been applied"; then
            echo "migrations_needed=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Pending migrations detected"
          else
            echo "migrations_needed=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  Migration status unclear, proceeding with caution"
          fi
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_UNPOOLED }}
          DATABASE_URL_UNPOOLED: ${{ secrets.DATABASE_URL_UNPOOLED }}

      - name: Apply database migrations
        if: steps.migration_check.outputs.migrations_needed == 'true'
        run: |
          echo "üöÄ Applying pending migrations to production..."
          npx prisma migrate deploy
          echo "‚úÖ Migrations applied successfully"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_UNPOOLED }}
          DATABASE_URL_UNPOOLED: ${{ secrets.DATABASE_URL_UNPOOLED }}

      - name: Verify migration success
        if: steps.migration_check.outputs.migrations_needed == 'true'
        run: |
          STATUS=$(npx prisma migrate status 2>&1)
          if echo "$STATUS" | grep -q "Database schema is up to date"; then
            echo "‚úÖ Migration verification passed"
          else
            echo "‚ùå Migration verification failed"
            echo "$STATUS"
            exit 1
          fi
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_UNPOOLED }}
          DATABASE_URL_UNPOOLED: ${{ secrets.DATABASE_URL_UNPOOLED }}

      - name: Build application
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_UNPOOLED }}
          DATABASE_URL_UNPOOLED: ${{ secrets.DATABASE_URL_UNPOOLED }}

      - name: Deployment notification
        run: |
          echo "============================================"
          echo "‚úÖ Production Deployment Complete"
          echo "============================================"
          echo ""
          echo "Migrations applied: ${{ steps.migration_check.outputs.migrations_needed }}"
          echo "Build status: Success"
          echo ""
          echo "Vercel will handle the actual deployment via GitHub integration"
          echo ""
