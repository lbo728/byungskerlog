name: Deploy to Staging

on:
  push:
    branches: [dev]
  workflow_dispatch:  # Manual trigger

jobs:
  deploy-staging:
    name: Deploy to Staging (Neon dev branch)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_DEV }}

      - name: Check migration status
        id: migration_check
        run: |
          STATUS=$(npx prisma migrate status 2>&1 || true)
          echo "$STATUS"
          
          if echo "$STATUS" | grep -q "Database schema is up to date"; then
            echo "migrations_needed=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Staging DB is up to date"
          elif echo "$STATUS" | grep -q "following migrations have not yet been applied"; then
            echo "migrations_needed=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Pending migrations for staging"
          else
            echo "migrations_needed=false" >> $GITHUB_OUTPUT
          fi
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_DEV }}

      - name: Apply migrations to staging
        if: steps.migration_check.outputs.migrations_needed == 'true'
        run: |
          echo "üöÄ Applying migrations to staging (dev branch)..."
          npx prisma migrate deploy
          echo "‚úÖ Staging migrations complete"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_DEV }}

      - name: Verify staging migration
        if: steps.migration_check.outputs.migrations_needed == 'true'
        run: |
          STATUS=$(npx prisma migrate status 2>&1)
          if echo "$STATUS" | grep -q "Database schema is up to date"; then
            echo "‚úÖ Staging verification passed"
          else
            echo "‚ö†Ô∏è  Staging verification warning"
            echo "$STATUS"
          fi
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_DEV }}

      - name: Build application (staging)
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_DEV }}

      - name: Run tests (optional)
        run: npm run test:run || echo "No tests configured"
        continue-on-error: true

      - name: Staging deployment summary
        run: |
          echo "============================================"
          echo "‚úÖ Staging Deployment Complete"
          echo "============================================"
          echo ""
          echo "Environment: Neon dev branch"
          echo "Migrations applied: ${{ steps.migration_check.outputs.migrations_needed }}"
          echo "Build status: Success"
          echo ""
          echo "Next step: Test on staging, then merge to main for production"
          echo ""
